<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家計管理アプリ</title>
    <link rel="icon" href="images/favicon2.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>スプレッドシート管理</header>
    <main>
      <navi>
        <a class="menuButton" href="index.html">支払登録</a>
        <a class="menuButton" href="history.html">履歴</a>
        <a class="menuButton" href="summary.html">月別集計</a>
        <a class="menuButton" href="setting.html">カード設定</a>
        <a class="menuButton" href="recurring.html">定期支払</a>
        <a class="nowMenuButton" href="manage.html">初期設定</a>
      </navi>
      <section>
        <h2>支払登録フォーム</h2>
        <button onclick="fetchSpreadsheetList()">📄 スプレッドシート一覧</button>
        <button onclick="createSpreadsheet()">🆕 家計管理アプリを新規作成</button>

        <div id="current-id">現在の紐づけID: <span id="spreadsheet-id">読み込み中...</span></div>

        <table id="sheet-list" style="display:none;">
          <thead>
            <tr>
              <th>名前</th>
              <th>URL</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </main>
    
    <script>
      const GAS_URL = "https://script.google.com/macros/s/AKfycbx-wXtw54xG7xKPtzVNQqQidQUlc4ehwKDP0Ixi8qdz58_N5uy3x0xH9RKQohbGb_OT/exec";

      async function getCurrentId() {
        const res = await fetch(`${GAS_URL}?mode=currentId`);
        const text = await res.text();
        document.getElementById("spreadsheet-id").textContent = text || "(未設定)";
      }

      async function fetchSpreadsheetList() {
        const res = await fetch(`${GAS_URL}?mode=listSheets`);
        const data = await res.json();
        const tbody = document.querySelector("#sheet-list tbody");
        tbody.innerHTML = "";

        data.forEach(file => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${file.name}</td>
            <td><a class="sheet-link" href="${file.url}" target="_blank">開く</a></td>
            <td><button onclick="selectSpreadsheet('${file.id}')">選択</button></td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById("sheet-list").style.display = "table";
      }

      async function selectSpreadsheet(id) {
        const res = await fetch(`${GAS_URL}?mode=set&id=${id}`);
        const msg = await res.text();
        alert("選択保存完了: " + msg);
        getCurrentId();
      }

      async function createSpreadsheet() {
        const res = await fetch(`${GAS_URL}?mode=create`);
        const data = await res.json();
        alert(`作成完了: ${data.name}`);
        getCurrentId();
      }

      // 初期表示
      getCurrentId();
    </script>
  </body>
</html>
